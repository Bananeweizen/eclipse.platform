package org.eclipse.ant.internal.ui;/* * (c) Copyright IBM Corp. 2000, 2001. * All Rights Reserved. */ import java.net.*;import java.util.*;import org.apache.tools.ant.Project;import org.eclipse.core.internal.runtime.Assert;import org.eclipse.jface.action.*;import org.eclipse.jface.resource.ImageDescriptor;import org.eclipse.jface.text.*;import org.eclipse.swt.SWT;import org.eclipse.swt.custom.StyleRange;import org.eclipse.swt.graphics.Color;import org.eclipse.swt.layout.*;import org.eclipse.swt.widgets.*;import org.eclipse.ui.part.ViewPart;import org.eclipse.ui.texteditor.FindReplaceAction;public class AntConsole extends ViewPart {	public final static String CONSOLE_ID = "org.eclipse.ant.ui.antconsole";	public final static String PROPERTY_PREFIX_FIND = "find_action.";		private TextViewer viewer;	private Action copyAction;	private Action selectAllAction;	private Action clearOutputAction;	private Action findAction;	private IDocument document;	private Vector styleRangeVector = new Vector(5);	private static Color ERROR_COLOR = new Color(null, 255, 0, 0); // red - exactly the same as debug Consol	private static Color WARN_COLOR = new Color(null, 255, 100, 0); // orange	private static Color INFO_COLOR = new Color(null, 0, 0, 255); // blue	private static Color VERBOSE_COLOR = new Color(null, 0, 200, 125); // green	private static Color DEBUG_COLOR = new Color(null, 0, 0, 0); // black	/**	 * Constructor for AntConsole	 */	public AntConsole() {		super();	}	protected void addContributions() {		// Create the actions.		copyAction = new Action(Policy.bind("console.copy")) {			public void run() {				copySelectionToClipboard();			}		};				selectAllAction = new Action(Policy.bind("console.selectAll")) {			public void run() {				selectAllText();			}		};				clearOutputAction = new Action(Policy.bind("console.clearOutput")) {			public void run() {				clearOutput();			}		};		clearOutputAction.setImageDescriptor(getImageDescriptor("icons/basic/clcl16/clear.gif"));				findAction = new FindReplaceAction(			AntUIPlugin.getResourceBundle(),			PROPERTY_PREFIX_FIND,			this);		findAction.setEnabled(true);					MenuManager mgr = new MenuManager();		mgr.setRemoveAllWhenShown(true);		mgr.addMenuListener(new IMenuListener() {			public void menuAboutToShow(IMenuManager mgr) {				fillContextMenu(mgr);			}		});		Menu menu = mgr.createContextMenu(viewer.getControl());		viewer.getControl().setMenu(menu);	}	public void append(String value) {		append(value, Project.MSG_INFO);	}		public void append(final String value, final int ouputLevel) {		getViewSite().getShell().getDisplay().syncExec(new Runnable() {			public void run() {				int start = document.get().length();				document.set(document.get() + value);				setOutputLevelColor(ouputLevel, start, value.length());				if (value.length() > 0)					viewer.revealRange(document.get().length() - 1, 1);			}		});	}	private void setOutputLevelColor(int level, int start, int end) {		switch (level) {			case Project.MSG_ERR: addRangeStyle(start, end, ERROR_COLOR); break;			case Project.MSG_WARN: addRangeStyle(start, end, WARN_COLOR); break;			case Project.MSG_INFO: addRangeStyle(start, end, INFO_COLOR); break;			case Project.MSG_VERBOSE: addRangeStyle(start, end, VERBOSE_COLOR); break;			case Project.MSG_DEBUG: addRangeStyle(start, end, DEBUG_COLOR); break;			default: addRangeStyle(start, end, INFO_COLOR);		}	}		private void addRangeStyle(int start, int length, Color color) {		if (styleRangeVector.size() != 0) {			StyleRange lastStyle = (StyleRange) styleRangeVector.lastElement();			if (color.equals(lastStyle.foreground))				lastStyle.length += length;			else				styleRangeVector.add(new StyleRange(start, length, color, null));		}		else			styleRangeVector.add(new StyleRange(start, length, color, null));		StyleRange[] styleArray = (StyleRange[]) styleRangeVector.toArray(new StyleRange[styleRangeVector.size()]);					viewer.getTextWidget().setStyleRanges(styleArray);			}		protected void copySelectionToClipboard() {		viewer.doOperation(viewer.COPY);	}		public void clearOutput() {		viewer.getTextWidget().setText("");		styleRangeVector.removeAllElements();	}		protected void fillContextMenu(IMenuManager manager) {		copyAction.setEnabled(viewer.canDoOperation(viewer.COPY));		selectAllAction.setEnabled(viewer.canDoOperation(viewer.SELECT_ALL));		manager.add(copyAction);		manager.add(selectAllAction);		manager.add(new Separator());		manager.add(findAction);		manager.add(clearOutputAction);	}	public Object getAdapter(Class required) {		if (IFindReplaceTarget.class.equals(required))			return viewer.getFindReplaceTarget();		return super.getAdapter(required);	}		protected ImageDescriptor getImageDescriptor(String relativePath) {		try {			URL installURL = AntUIPlugin.getPlugin().getDescriptor().getInstallURL();			URL url = new URL(installURL,relativePath);			return ImageDescriptor.createFromURL(url);		}		catch (MalformedURLException e) {			Assert.isTrue(false);			return null;		}	}	protected void selectAllText() {		viewer.doOperation(viewer.SELECT_ALL);	}		/**	 * @see WorkbenchPart#setFocus()	 */	public void setFocus() {	}	/**	 * @see WorkbenchPart#createPartControl(Composite)	 */	public void createPartControl(Composite parent) {		Composite composite = new Composite(parent, SWT.NULL);		GridLayout compositeLayout = new GridLayout();		compositeLayout.marginHeight = 0;		compositeLayout.marginWidth = 0;		composite.setLayout(compositeLayout);		composite.setLayoutData(new GridData(			GridData.VERTICAL_ALIGN_FILL | GridData.HORIZONTAL_ALIGN_FILL));		viewer = new TextViewer(composite,SWT.WRAP | SWT.V_SCROLL | SWT.H_SCROLL);		GridData data = new GridData(GridData.FILL_BOTH);		viewer.setEditable(false);		viewer.getControl().setLayoutData(data);		document = new Document();		viewer.setDocument(document);		addContributions();		initializeToolbar();	}		protected void initializeToolbar() {		IToolBarManager tbm= getViewSite().getActionBars().getToolBarManager();		tbm.add(clearOutputAction);		getViewSite().getActionBars().updateActionBars();	}		public void dispose() {		ERROR_COLOR.dispose();		WARN_COLOR.dispose();		INFO_COLOR.dispose();		VERBOSE_COLOR.dispose();		DEBUG_COLOR.dispose();		super.dispose();	}}